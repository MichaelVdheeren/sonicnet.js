{"version":3,"sources":["webpack:///webpack/bootstrap 63654a6474f41013f9b6","webpack:///../lib/src/audiocontext.js","webpack:///../lib/src/index.js","webpack:///../lib/src/ring-buffer.js","webpack:///../lib/src/sonic-coder.js","webpack:///../lib/src/sonic-server.js","webpack:///../lib/src/sonic-socket.js","webpack:///./chat-pair/index.js","webpack:///./chat-pair/pair-client.js"],"names":["AudioContext","window","webkitAudioContext","audioContext","createGainNode","audioCtx","createGain","sonicnet","SonicSocket","SonicServer","SonicCoder","RingBuffer","maxLength","array","get","index","length","last","add","value","push","splice","clear","copy","out","slice","remove","ALPHABET","params","freqMin","freqMax","freqError","alphabetString","alphabet","startChar","endChar","charToFreq","char","indexOf","console","error","freqRange","percent","freqOffset","Math","round","freqToChar","freq","State","IDLE","RECV","peakThreshold","minRunLength","coder","timeout","debug","peakHistory","peakTimes","callbacks","buffer","state","isRunning","iteration","start","constraints","audio","optional","echoCancellation","navigator","getMedia","getUserMedia","webkitGetUserMedia","mozGetUserMedia","msGetUserMedia","onStream_","bind","onStreamError_","stop","track","on","event","callback","message","character","setDebug","canvas","document","querySelector","parentElement","removeChild","fire_","arg","stream","getTracks","input","createMediaStreamSource","analyser","createAnalyser","connect","freqs","Float32Array","frequencyBinCount","raf_","loop","e","getPeakFrequency","freqToIndex","max","Infinity","i","indexToFreq","getFloatFrequencyData","restartServerIfSanityCheckFails","log","Date","lastPeakTime","analysePeaks","debugDraw_","nyquist","sampleRate","frequency","getLastRun","lastChar","runLength","createElement","body","appendChild","width","offsetWidth","height","drawContext","getContext","offset","barWidth","fillStyle","fillRect","isCrx","chrome","extension","setTimeout","requestAnimationFrame","restart","isValid","location","reload","charDuration","rampDuration","send","opt_callback","time","currentTime","scheduleToneAt","totalTime","startTime","duration","gainNode","gain","setValueAtTime","linearRampToValueAtTime","destination","osc","createOscillator","TOKEN_LENGTH","sonicServer","sonicSocket","pairClient","token","changeNameButton","connectButton","chatForm","chatBox","userName","localStorage","history","wrap","init","initPair","generateToken","isServerError","onServerError","onIncomingChat","onConnected","onDisconnected","onPairReady","onToken","initUI","addEventListener","startChatHandler","submitHandler","changeNameHandler","oldName","getUserName","newName","prompt","authorMessage","getAuthorMessage","addChatLine","preventDefault","newToken","count","floor","random","otherToken","confirm","text","innerHTML","classList","style","display","focus","author","formattedText","getTime","scrollTop","scrollHeight","now","hours","getHours","mins","getMinutes","secs","getSeconds","undefined","PairClient","conn_id","socket","WebSocket","onmessage","onMessage_","onerror","onError_","msg","JSON","stringify","type","onopen","connected","disconnected","pairConfirm","json","parse","data","err","info"],"mappings":"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","file":"chat-pair/build/all.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 1);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 63654a6474f41013f9b6","const AudioContext = window.AudioContext || window.webkitAudioContext;\nconst audioContext = window.audioContext || new AudioContext();\n\nconst createGainNode = (audioCtx) => {\n  if (audioCtx.createGain && audioCtx.createGain()) {\n    return audioCtx.createGain();\n  }\n\n  if (audioCtx.createGainNode && audioCtx.createGainNode()) {\n    return audioCtx.createGainNode();\n  }\n\n  return null;\n};\n\nexport default audioContext;\n\nexport {\n  audioContext,\n  createGainNode\n}\n\n\n\n// WEBPACK FOOTER //\n// ../lib/src/audiocontext.js","import SonicSocket from './sonic-socket';\nimport SonicServer from './sonic-server';\nimport SonicCoder from './sonic-coder';\n\nconst sonicnet = {\n  SonicSocket,\n  SonicServer,\n  SonicCoder\n};\n\nexport default sonicnet;\n\nexport {\n  SonicSocket,\n  SonicServer,\n  SonicCoder\n};\n\n\n\n// WEBPACK FOOTER //\n// ../lib/src/index.js","class RingBuffer {\n  constructor(maxLength) {\n    this.array = [];\n    this.maxLength = maxLength;\n  }\n\n  get(index) {\n    if (index >= this.array.length) {\n      return null;\n    }\n    return this.array[index];\n  }\n\n  last() {\n    if (this.array.length === 0) {\n      return null;\n    }\n    return this.array[this.array.length - 1];\n  }\n\n  add(value) {\n    // Append to the end, remove from the front.\n    this.array.push(value);\n    if (this.array.length >= this.maxLength) {\n      this.array.splice(0, 1);\n    }\n  }\n\n  length() {\n    // Return the actual size of the array.\n    return this.array.length;\n  }\n\n  clear() {\n    this.array = [];\n  }\n\n  copy() {\n    // Returns a copy of the ring buffer.\n    const out = new RingBuffer(this.maxLength);\n    out.array = this.array.slice(0);\n    return out;\n  }\n\n  remove(index, length) {\n    //console.log('Removing', index, 'through', index+length);\n    this.array.splice(index, length);\n  }\n}\n\nexport default RingBuffer;\n\n\n\n// WEBPACK FOOTER //\n// ../lib/src/ring-buffer.js","/**\n * A simple sonic encoder/decoder for [a-z0-9] => frequency (and back).\n * A way of representing characters with frequency.\n */\nconst ALPHABET = '\\n abcdefghijklmnopqrstuvwxyz0123456789,.!?@*';\n\nclass SonicCoder {\n  constructor(params = {}) {\n    this.freqMin = params.freqMin || 18500;\n    this.freqMax = params.freqMax || 19500;\n    this.freqError = params.freqError || 50;\n    this.alphabetString = params.alphabet || ALPHABET;\n    this.startChar = params.startChar || '^';\n    this.endChar = params.endChar || '$';\n    // Make sure that the alphabet has the start and end chars.\n    this.alphabet = this.startChar + this.alphabetString + this.endChar;\n  }\n\n  /**\n   * Given a character, convert to the corresponding frequency.\n   */\n  charToFreq(char) {\n    // Get the index of the character.\n    let index = this.alphabet.indexOf(char);\n    if (index === -1) {\n      // If this character isn't in the alphabet, error out.\n      console.error(char, 'is an invalid character.');\n      index = this.alphabet.length - 1;\n    }\n    // Convert from index to frequency.\n    const freqRange = this.freqMax - this.freqMin;\n    const percent = index / this.alphabet.length;\n    const freqOffset = Math.round(freqRange * percent);\n\n    return this.freqMin + freqOffset;\n  }\n\n  /**\n   * Given a frequency, convert to the corresponding character.\n   */\n  freqToChar(freq) {\n    // If the frequency is out of the range.\n    if (!(this.freqMin < freq && freq < this.freqMax)) {\n      // If it's close enough to the min, clamp it (and same for max).\n      if (this.freqMin - freq < this.freqError) {\n        freq = this.freqMin;\n      } else if (freq - this.freqMax < this.freqError) {\n        freq = this.freqMax;\n      } else {\n        // Otherwise, report error.\n        console.error(freq, 'is out of range.');\n        return null;\n      }\n    }\n    // Convert frequency to index to char.\n    const freqRange = this.freqMax - this.freqMin;\n    const percent = (freq - this.freqMin) / freqRange;\n    const index = Math.round(this.alphabet.length * percent);\n\n    return this.alphabet[index];\n  }\n}\n\nexport default SonicCoder;\n\n\n\n// WEBPACK FOOTER //\n// ../lib/src/sonic-coder.js","import RingBuffer from './ring-buffer.js';\nimport SonicCoder from './sonic-coder.js';\nimport audioContext from './audiocontext';\n\nconst State = {\n  IDLE: 1,\n  RECV: 2\n};\n\n/**\n * Extracts meaning from audio streams.\n *\n * (assumes audioContext is an AudioContext global variable.)\n *\n * 1. Listen to the microphone.\n * 2. Do an FFT on the input.\n * 3. Extract frequency peaks in the ultrasonic range.\n * 4. Keep track of frequency peak history in a ring buffer.\n * 5. Call back when a peak comes up often enough.\n */\nclass SonicServer {\n  constructor(params = {}) {\n    this.peakThreshold = params.peakThreshold || -65;\n    this.minRunLength = params.minRunLength || 2;\n    this.coder = params.coder || new SonicCoder(params);\n    // How long (in ms) to wait for the next character.\n    this.timeout = params.timeout || 300;\n    this.debug = !!params.debug;\n\n    this.peakHistory = new RingBuffer(16);\n    this.peakTimes = new RingBuffer(16);\n\n    this.callbacks = {};\n\n    this.buffer = '';\n    this.state = State.IDLE;\n    this.isRunning = false;\n    this.iteration = 0;\n  }\n  /**\n   * Start processing the audio stream.\n   */\n  start() {\n    // Start listening for microphone. Continue init in onStream.\n    const constraints = {\n      audio: { optional: [{ echoCancellation: false }] }\n    };\n    navigator.getMedia = (\n      navigator.getUserMedia ||\n      navigator.webkitGetUserMedia ||\n      navigator.mozGetUserMedia ||\n      navigator.msGetUserMedia\n    );\n\n    navigator.getMedia(\n      { audio: true },\n      this.onStream_.bind(this),\n      this.onStreamError_.bind(this)\n    );\n  }\n  /**\n   * Stop processing the audio stream.\n   */\n  stop() {\n    this.isRunning = false;\n    this.track.stop();\n  }\n  on(event, callback) {\n    if (event === 'message') {\n      this.callbacks.message = callback;\n    }\n    if (event === 'character') {\n      this.callbacks.character = callback;\n    }\n  }\n  setDebug(value) {\n    this.debug = value;\n\n    const canvas = document.querySelector('canvas');\n    if (canvas) {\n      // Remove it.\n      canvas.parentElement.removeChild(canvas);\n    }\n  }\n\n  fire_(callback, arg) {\n    if (typeof(callback) === 'function') {\n      callback(arg);\n    }\n  }\n\n  onStream_(stream) {\n    // Store MediaStreamTrack for stopping later. MediaStream.stop() is deprecated\n    // See https://developers.google.com/web/updates/2015/07/mediastream-deprecations?hl=en\n    this.track = stream.getTracks()[0];\n\n    // Setup audio graph.\n    const input = audioContext.createMediaStreamSource(stream);\n    const analyser = audioContext.createAnalyser();\n    input.connect(analyser);\n    // Create the frequency array.\n    this.freqs = new Float32Array(analyser.frequencyBinCount);\n    // Save the analyser for later.\n    this.analyser = analyser;\n    this.isRunning = true;\n    // Do an FFT and check for inaudible peaks.\n    this.raf_(this.loop.bind(this));\n  }\n\n  onStreamError_(e) {\n    console.error('Audio input error:', e);\n  }\n\n  /**\n   * Given an FFT frequency analysis, return the peak frequency in a frequency\n   * range.\n   */\n  getPeakFrequency() {\n    // Find where to start.\n    const start = this.freqToIndex(this.coder.freqMin);\n    // TODO: use first derivative to find the peaks, and then find the largest peak.\n    // Just do a max over the set.\n    let max = -Infinity;\n    let index = -1;\n    for (let i = start; i < this.freqs.length; i++) {\n      if (this.freqs[i] > max) {\n        max = this.freqs[i];\n        index = i;\n      }\n    }\n    // Only care about sufficiently tall peaks.\n    if (max > this.peakThreshold) {\n      return this.indexToFreq(index);\n    }\n    return null;\n  }\n\n  loop() {\n    this.analyser.getFloatFrequencyData(this.freqs);\n    // Sanity check the peaks every 5 seconds.\n    if ((this.iteration + 1) % (60 * 5) == 0) {\n      this.restartServerIfSanityCheckFails();\n    }\n    // Calculate peaks, and add them to history.\n    const freq = this.getPeakFrequency();\n    if (freq) {\n      const char = this.coder.freqToChar(freq);\n      // DEBUG ONLY: Output the transcribed char.\n      if (this.debug) {\n        console.log('Transcribed char: ' + char);\n      }\n      this.peakHistory.add(char);\n      this.peakTimes.add(new Date());\n    } else {\n      // If no character was detected, see if we've timed out.\n      const lastPeakTime = this.peakTimes.last();\n      if (lastPeakTime && new Date() - lastPeakTime > this.timeout) {\n        // Last detection was over 300ms ago.\n        this.state = State.IDLE;\n        if (this.debug) {\n          console.log('Token', this.buffer, 'timed out');\n        }\n        this.peakTimes.clear();\n      }\n    }\n    // Analyse the peak history.\n    this.analysePeaks();\n    // DEBUG ONLY: Draw the frequency response graph.\n    if (this.debug) {\n      this.debugDraw_();\n    }\n    if (this.isRunning) {\n      this.raf_(this.loop.bind(this));\n    }\n    this.iteration += 1;\n  }\n\n  indexToFreq(index) {\n    const nyquist = audioContext.sampleRate/2;\n    return nyquist/this.freqs.length * index;\n  }\n\n  freqToIndex(frequency) {\n    const nyquist = audioContext.sampleRate/2;\n    return Math.round(frequency/nyquist * this.freqs.length);\n  }\n\n  /**\n   * Analyses the peak history to find true peaks (repeated over several frames).\n   */\n  analysePeaks() {\n    // Look for runs of repeated characters.\n    const char = this.getLastRun();\n    if (!char) {\n      return;\n    }\n    if (this.state === State.IDLE) {\n      // If idle, look for start character to go into recv mode.\n      if (char === this.coder.startChar) {\n        this.buffer = '';\n        this.state = State.RECV;\n      }\n    } else if (this.state === State.RECV) {\n      // If receiving, look for character changes.\n      if (char !== this.lastChar &&\n          char !== this.coder.startChar && char !== this.coder.endChar) {\n        this.buffer += char;\n        this.lastChar = char;\n        this.fire_(this.callbacks.character, char);\n      }\n      // Also look for the end character to go into idle mode.\n      if (char === this.coder.endChar) {\n        this.state = State.IDLE;\n        this.fire_(this.callbacks.message, this.buffer);\n        this.buffer = '';\n      }\n    }\n  }\n\n  getLastRun() {\n    const lastChar = this.peakHistory.last();\n    let runLength = 0;\n    let i = this.peakHistory.length() - 2;\n    // Look at the peakHistory array for patterns like ajdlfhlkjxxxxxx$.\n    for (i; i >= 0; i--) {\n      const char = this.peakHistory.get(i);\n      if (char === lastChar) {\n        runLength += 1;\n      } else {\n        break;\n      }\n    }\n    if (runLength > this.minRunLength) {\n      // Remove it from the buffer.\n      this.peakHistory.remove(i + 1, runLength + 1);\n      return lastChar;\n    }\n    return null;\n  }\n\n  /**\n   * DEBUG ONLY.\n   */\n  debugDraw_() {\n    let canvas = document.querySelector('canvas');\n    if (!canvas) {\n      canvas = document.createElement('canvas');\n      document.body.appendChild(canvas);\n    }\n    canvas.width = document.body.offsetWidth;\n    canvas.height = 480;\n    const drawContext = canvas.getContext('2d');\n    // Plot the frequency data.\n    for (let i = 0; i < this.freqs.length; i++) {\n      const value = this.freqs[i];\n      // Transform this value (in db?) into something that can be plotted.\n      const height = value + 400;\n      const offset = canvas.height - height - 1;\n      const barWidth = canvas.width/this.freqs.length;\n      drawContext.fillStyle = 'black';\n      drawContext.fillRect(i * barWidth, offset, 1, 1);\n    }\n  }\n\n  /**\n   * A request animation frame shortcut. This one is intended to work even in\n   * background pages of an extension.\n   */\n  raf_(callback) {\n    const isCrx = !!(window.chrome && chrome.extension);\n    if (isCrx) {\n      setTimeout(callback, 1000/60);\n    } else {\n      requestAnimationFrame(callback);\n    }\n  }\n\n  restartServerIfSanityCheckFails() {\n    // Strange state 1: peaks gradually get quieter and quieter until they\n    // stabilize around -800.\n    if (this.freqs[0] < -300) {\n      console.error('freqs[0] < -300. Restarting.');\n      this.restart();\n      return;\n    }\n    // Strange state 2: all of the peaks are -100. Check just the first few.\n    let isValid = true;\n    for (let i = 0; i < 10; i++) {\n      if (this.freqs[i] === -100) {\n        isValid = false;\n      }\n    }\n    if (!isValid) {\n      console.error('freqs[0:10] == -100. Restarting.');\n      this.restart();\n    }\n  }\n\n  restart() {\n    //this.stop();\n    //this.start();\n    window.location.reload();\n  }\n}\n\nexport default SonicServer;\n\n\n\n// WEBPACK FOOTER //\n// ../lib/src/sonic-server.js","import SonicCoder from './sonic-coder.js';\nimport { audioContext, createGainNode } from './audiocontext';\n\n/**\n * Encodes text as audio streams.\n *\n * 1. Receives a string of text.\n * 2. Creates an oscillator.\n * 3. Converts characters into frequencies.\n * 4. Transmits frequencies, waiting in between appropriately.\n */\nclass SonicSocket {\n  constructor(params = {}) {\n    this.charDuration = params.charDuration || 0.2;\n    this.coder = params.coder || new SonicCoder(params);\n    this.rampDuration = params.rampDuration || 0.001;\n  }\n\n  send(input, opt_callback) {\n    // Surround the word with start and end characters.\n    input = this.coder.startChar + input + this.coder.endChar;\n    // Use WAAPI to schedule the frequencies.\n    for (let i = 0; i < input.length; i++) {\n      const char = input[i];\n      const freq = this.coder.charToFreq(char);\n      const time = audioContext.currentTime + this.charDuration * i;\n      this.scheduleToneAt(freq, time, this.charDuration);\n    }\n\n    // If specified, callback after roughly the amount of time it would have\n    // taken to transmit the token.\n    if (opt_callback) {\n      const totalTime = this.charDuration * input.length;\n      setTimeout(opt_callback, totalTime * 1000);\n    }\n  }\n\n  scheduleToneAt(freq, startTime, duration) {\n    // Gain => Merger\n    const gainNode = createGainNode(audioContext);\n    gainNode.gain.value = 0;\n\n    gainNode.gain.setValueAtTime(0, startTime);\n    gainNode.gain.linearRampToValueAtTime(1, startTime + this.rampDuration);\n    gainNode.gain.setValueAtTime(1, startTime + duration - this.rampDuration);\n    gainNode.gain.linearRampToValueAtTime(0, startTime + duration);\n\n    gainNode.connect(audioContext.destination);\n\n    const osc = audioContext.createOscillator();\n    osc.frequency.value = freq;\n    osc.connect(gainNode);\n\n    osc.start(startTime);\n  }\n}\n\nexport default SonicSocket;\n\n\n\n// WEBPACK FOOTER //\n// ../lib/src/sonic-socket.js","import { SonicSocket, SonicServer } from '../../lib/src/index';\nimport PairClient from './pair-client.js';\n\nconst ALPHABET = '0123456789';\nconst TOKEN_LENGTH = 5;\n\n// Create an ultranet server.\nconst sonicServer = new SonicServer({alphabet: ALPHABET, debug: true});\n// Create an ultranet socket.\nconst sonicSocket = new SonicSocket({alphabet: ALPHABET});\n// Create a connection to the pairing server.\nconst pairClient = new PairClient();\n\nlet token;\n\n// UI Parts\nconst changeNameButton = document.querySelector('#change-name');\nconst connectButton = document.querySelector('#connect');\nconst chatForm = document.querySelector('#say');\nconst chatBox = chatForm.querySelector('input');\nconst userName = localStorage.userName || null;\nconst history = document.querySelector('#history');\nconst wrap = document.querySelector('#history-wrap');\n\nfunction init() {\n  // Start the pairing thing.\n  initPair();\n}\n\nfunction initPair() {\n  // Generate a random pairing token.\n  token = generateToken();\n\n  if (pairClient.isServerError) {\n    onServerError();\n  }\n  // Setup a connection to the pairing server when it's ready.\n  pairClient.on('ready', function() {\n    pairClient.start(token);\n  });\n  // Listen for messages from other clients.\n  pairClient.on('message', onIncomingChat);\n  pairClient.on('connected', onConnected);\n  pairClient.on('disconnected', onDisconnected);\n  pairClient.on('pair-confirm', onPairReady);\n\n  // Start an ultranet server.\n  sonicServer.start();\n  // Start listening for messages on the sonic server.\n  sonicServer.on('message', onToken);\n}\n\nfunction initUI() {\n  connectButton.addEventListener('click', startChatHandler);\n  chatForm.addEventListener('submit', submitHandler);\n  changeNameButton.addEventListener('click', changeNameHandler);\n\n  function startChatHandler() {\n    // Send the pairing token to nearby ultranet clients.\n    sonicSocket.send(token);\n  }\n\n  function changeNameHandler() {\n    const oldName = getUserName();\n    const newName = prompt('New user name (was ' + oldName + ')');\n    if (newName) {\n      localStorage.userName = newName;\n    }\n  }\n\n  function submitHandler(e) {\n    // Broadcast the message out to the other client (if one exists).\n    const authorMessage = getAuthorMessage(getUserName(), chatBox.value)\n    // Send through socket.\n    pairClient.send(authorMessage);\n    // Clear form.\n    chatBox.value = '';\n    // Update the chat box.\n    addChatLine(authorMessage);\n    // Prevent the page from reloading.\n    e.preventDefault();\n  }\n\n}\n\nfunction generateToken() {\n  let newToken = '';\n  let count = 0;\n  let char;\n  let lastChar;\n  while (count < TOKEN_LENGTH) {\n    console.log(count, TOKEN_LENGTH);\n    // Generate a random value from the alphabet.\n    const index = Math.floor(Math.random() * ALPHABET.length);\n    char = ALPHABET[index];\n    if (char !== lastChar) {\n      count += 1;\n      newToken += char;\n      lastChar = char;\n      console.log(lastChar, char);\n    }\n  }\n  return newToken;\n}\n\nfunction onToken(otherToken) {\n  console.log('Got token', otherToken, token);\n  // Don't connect to yourself!\n  //if (token !== otherToken) {\n    // Attempt to confirm the connection with the pair server.\n    pairClient.confirm(otherToken);\n  //}\n}\n\nfunction onIncomingChat(text) {\n  addChatLine(text);\n}\n\nfunction onPairReady() {\n  // Change the text to be \"Connect!\".\n  connectButton.querySelector('span').innerHTML = 'Connect!';\n  // Change the button styling to be enabled.\n  connectButton.classList.remove('disabled');\n  // Configure UI.\n  initUI();\n}\n\nfunction onConnected() {\n  // Hide the overlay.\n  document.querySelector('#overlay').style.display = 'none';\n  // Place cursor inside input box.\n  chatBox.focus();\n}\n\nfunction onDisconnected() {\n  // Show the overlay.\n  document.querySelector('#overlay').style.display = 'block';\n}\n\nfunction onServerError() {\n  // Update the error dialog.\n  connectButton.querySelector('span').innerHTML = 'Server error!';\n}\n\nfunction getAuthorMessage(author, message) {\n  return author + ': ' + message;\n}\n\nfunction addChatLine(text) {\n  const formattedText = getTime() + ' ' + text;\n  history.innerHTML += formattedText + '<br/>';\n\n  // Scroll history to the bottom.\n  wrap.scrollTop = history.scrollHeight;\n}\n\nfunction getTime() {\n  let now = new Date();\n  let hours = now.getHours();\n  hours = (hours > 9 ? hours: ' ' + hours);\n  let mins = now.getMinutes();\n  mins = (mins > 9 ? mins : '0' + mins);\n  let secs = now.getSeconds();\n  secs = (secs > 9 ? secs : '0' + secs);\n  return '[' + hours + ':' + mins + ':' + secs + ']';\n}\n\nfunction getUserName() {\n  return (localStorage.userName === undefined ?\n          'Anonymous' : localStorage.userName);\n}\n\nwindow.addEventListener('load', init);\n\n\n\n// WEBPACK FOOTER //\n// ./chat-pair/index.js","class PairClient {\n  constructor() {\n    this.conn_id = null;\n    // Create a websocket connection to the server.\n    this.socket = new WebSocket('ws://0.0.0.0:8080');\n    this.socket.onmessage = this.onMessage_.bind(this);\n    this.socket.onerror = this.onError_.bind(this);\n\n    // All callbacks.\n    this.callbacks = {};\n  }\n\n  start(token) {\n    const msg = JSON.stringify({type: 'start', token: token});\n    this.socket.send(msg);\n  }\n\n  confirm(token) {\n    const msg = JSON.stringify({type: 'confirm', token: token});\n    this.socket.send(msg);\n  }\n\n  send(message) {\n    if (this.conn_id === null) {\n      console.error('No connection ID.');\n      return;\n    }\n    const msg = JSON.stringify(\n        {type: 'message', conn_id: this.conn_id, message: message});\n    this.socket.send(msg);\n  }\n\n  on(event, callback) {\n    if (event === 'ready') {\n      this.socket.onopen = callback;\n    }\n    if (event === 'message') {\n      this.callbacks.message = callback;\n    }\n    if (event === 'connected') {\n      this.callbacks.connected = callback;\n    }\n    if (event === 'disconnected') {\n      this.callbacks.disconnected = callback;\n    }\n    if (event === 'pair-confirm') {\n      this.callbacks.pairConfirm = callback;\n    }\n  }\n\n  /***** Private *******/\n  onMessage_(e) {\n    let json;\n    try {\n      json = JSON.parse(e.data);\n    } catch (err) {\n      console.error('Message must be in JSON format.', err, e.data);\n      return;\n    }\n    if (json.type === 'connected') {\n      this.conn_id = json.conn_id;\n      console.log('Connection #' + this.conn_id + ' opened.');\n      this.fire_(this.callbacks.connected);\n    }\n    if (json.type === 'message') {\n      console.log('Received: ' + json.message);\n      this.fire_(this.callbacks.message, json.message);\n    }\n    if (json.type === 'disconnected') {\n      this.conn_id = null;\n      this.fire_(this.callbacks.disconnected);\n    }\n    if (json.type === 'pair-confirm') {\n      this.fire_(this.callbacks.pairConfirm);\n    }\n    if (json.info) {\n      console.log('Info: ' + json.info);\n      // TODO(smus): Get rid of this bit and replace it with pair-confirm event\n      // from server.\n      if (json.info === 'Got a pair request.') {\n        this.fire_(this.callbacks.pairConfirm);\n      }\n    }\n    if (json.error) {\n      console.error('Error: ' + json.error);\n    }\n  }\n\n  fire_(callback, arg) {\n    if (callback) {\n      callback(arg);\n    }\n  }\n\n  onError_(err) {\n    console.error(err);\n    this.isServerError = true;\n  }\n}\n\nexport default PairClient;\n\n\n\n// WEBPACK FOOTER //\n// ./chat-pair/pair-client.js"],"sourceRoot":""}