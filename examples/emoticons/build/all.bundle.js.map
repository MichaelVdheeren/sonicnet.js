{"version":3,"sources":["webpack:///webpack/bootstrap 63654a6474f41013f9b6","webpack:///../lib/src/audiocontext.js","webpack:///../lib/src/index.js","webpack:///../lib/src/ring-buffer.js","webpack:///../lib/src/sonic-coder.js","webpack:///../lib/src/sonic-server.js","webpack:///../lib/src/sonic-socket.js","webpack:///./emoticons/index.js"],"names":["AudioContext","window","webkitAudioContext","audioContext","createGainNode","audioCtx","createGain","sonicnet","SonicSocket","SonicServer","SonicCoder","RingBuffer","maxLength","array","get","index","length","last","add","value","push","splice","clear","copy","out","slice","remove","ALPHABET","params","freqMin","freqMax","freqError","alphabetString","alphabet","startChar","endChar","charToFreq","char","indexOf","console","error","freqRange","percent","freqOffset","Math","round","freqToChar","freq","State","IDLE","RECV","peakThreshold","minRunLength","coder","timeout","debug","peakHistory","peakTimes","callbacks","buffer","state","isRunning","iteration","start","constraints","audio","optional","echoCancellation","navigator","getMedia","getUserMedia","webkitGetUserMedia","mozGetUserMedia","msGetUserMedia","onStream_","bind","onStreamError_","stop","track","on","event","callback","message","character","setDebug","canvas","document","querySelector","parentElement","removeChild","fire_","arg","stream","getTracks","input","createMediaStreamSource","analyser","createAnalyser","connect","freqs","Float32Array","frequencyBinCount","raf_","loop","e","getPeakFrequency","freqToIndex","max","Infinity","i","indexToFreq","getFloatFrequencyData","restartServerIfSanityCheckFails","log","Date","lastPeakTime","analysePeaks","debugDraw_","nyquist","sampleRate","frequency","getLastRun","lastChar","runLength","createElement","body","appendChild","width","offsetWidth","height","drawContext","getContext","offset","barWidth","fillStyle","fillRect","isCrx","chrome","extension","setTimeout","requestAnimationFrame","restart","isValid","location","reload","charDuration","rampDuration","send","opt_callback","time","currentTime","scheduleToneAt","totalTime","startTime","duration","gainNode","gain","setValueAtTime","linearRampToValueAtTime","destination","osc","createOscillator","EMOTICONS","generateAlphabet","PLACEHOLDER","sonicSocket","sonicServer","createSonicNetwork","opt_coder","onIncomingEmoticon","createEmoticonList","isMobile","style","display","isAudibleEl","addEventListener","target","checked","isFullScreenEl","selectEl","recvEl","classList","isVisualizer","list","min","toString","onPickEmoticon","emoticonEl","name","dataset","emoticonEls","querySelectorAll","el","emoticonListEl","src","getIcon","parseInt","isNaN","check","a","test","substr","userAgent","vendor","opera"],"mappings":"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","file":"emoticons/build/all.bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 2);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 63654a6474f41013f9b6","const AudioContext = window.AudioContext || window.webkitAudioContext;\nconst audioContext = window.audioContext || new AudioContext();\n\nconst createGainNode = (audioCtx) => {\n  if (audioCtx.createGain && audioCtx.createGain()) {\n    return audioCtx.createGain();\n  }\n\n  if (audioCtx.createGainNode && audioCtx.createGainNode()) {\n    return audioCtx.createGainNode();\n  }\n\n  return null;\n};\n\nexport default audioContext;\n\nexport {\n  audioContext,\n  createGainNode\n}\n\n\n\n// WEBPACK FOOTER //\n// ../lib/src/audiocontext.js","import SonicSocket from './sonic-socket';\nimport SonicServer from './sonic-server';\nimport SonicCoder from './sonic-coder';\n\nconst sonicnet = {\n  SonicSocket,\n  SonicServer,\n  SonicCoder\n};\n\nexport default sonicnet;\n\nexport {\n  SonicSocket,\n  SonicServer,\n  SonicCoder\n};\n\n\n\n// WEBPACK FOOTER //\n// ../lib/src/index.js","class RingBuffer {\n  constructor(maxLength) {\n    this.array = [];\n    this.maxLength = maxLength;\n  }\n\n  get(index) {\n    if (index >= this.array.length) {\n      return null;\n    }\n    return this.array[index];\n  }\n\n  last() {\n    if (this.array.length === 0) {\n      return null;\n    }\n    return this.array[this.array.length - 1];\n  }\n\n  add(value) {\n    // Append to the end, remove from the front.\n    this.array.push(value);\n    if (this.array.length >= this.maxLength) {\n      this.array.splice(0, 1);\n    }\n  }\n\n  length() {\n    // Return the actual size of the array.\n    return this.array.length;\n  }\n\n  clear() {\n    this.array = [];\n  }\n\n  copy() {\n    // Returns a copy of the ring buffer.\n    const out = new RingBuffer(this.maxLength);\n    out.array = this.array.slice(0);\n    return out;\n  }\n\n  remove(index, length) {\n    //console.log('Removing', index, 'through', index+length);\n    this.array.splice(index, length);\n  }\n}\n\nexport default RingBuffer;\n\n\n\n// WEBPACK FOOTER //\n// ../lib/src/ring-buffer.js","/**\n * A simple sonic encoder/decoder for [a-z0-9] => frequency (and back).\n * A way of representing characters with frequency.\n */\nconst ALPHABET = '\\n abcdefghijklmnopqrstuvwxyz0123456789,.!?@*';\n\nclass SonicCoder {\n  constructor(params = {}) {\n    this.freqMin = params.freqMin || 18500;\n    this.freqMax = params.freqMax || 19500;\n    this.freqError = params.freqError || 50;\n    this.alphabetString = params.alphabet || ALPHABET;\n    this.startChar = params.startChar || '^';\n    this.endChar = params.endChar || '$';\n    // Make sure that the alphabet has the start and end chars.\n    this.alphabet = this.startChar + this.alphabetString + this.endChar;\n  }\n\n  /**\n   * Given a character, convert to the corresponding frequency.\n   */\n  charToFreq(char) {\n    // Get the index of the character.\n    let index = this.alphabet.indexOf(char);\n    if (index === -1) {\n      // If this character isn't in the alphabet, error out.\n      console.error(char, 'is an invalid character.');\n      index = this.alphabet.length - 1;\n    }\n    // Convert from index to frequency.\n    const freqRange = this.freqMax - this.freqMin;\n    const percent = index / this.alphabet.length;\n    const freqOffset = Math.round(freqRange * percent);\n\n    return this.freqMin + freqOffset;\n  }\n\n  /**\n   * Given a frequency, convert to the corresponding character.\n   */\n  freqToChar(freq) {\n    // If the frequency is out of the range.\n    if (!(this.freqMin < freq && freq < this.freqMax)) {\n      // If it's close enough to the min, clamp it (and same for max).\n      if (this.freqMin - freq < this.freqError) {\n        freq = this.freqMin;\n      } else if (freq - this.freqMax < this.freqError) {\n        freq = this.freqMax;\n      } else {\n        // Otherwise, report error.\n        console.error(freq, 'is out of range.');\n        return null;\n      }\n    }\n    // Convert frequency to index to char.\n    const freqRange = this.freqMax - this.freqMin;\n    const percent = (freq - this.freqMin) / freqRange;\n    const index = Math.round(this.alphabet.length * percent);\n\n    return this.alphabet[index];\n  }\n}\n\nexport default SonicCoder;\n\n\n\n// WEBPACK FOOTER //\n// ../lib/src/sonic-coder.js","import RingBuffer from './ring-buffer.js';\nimport SonicCoder from './sonic-coder.js';\nimport audioContext from './audiocontext';\n\nconst State = {\n  IDLE: 1,\n  RECV: 2\n};\n\n/**\n * Extracts meaning from audio streams.\n *\n * (assumes audioContext is an AudioContext global variable.)\n *\n * 1. Listen to the microphone.\n * 2. Do an FFT on the input.\n * 3. Extract frequency peaks in the ultrasonic range.\n * 4. Keep track of frequency peak history in a ring buffer.\n * 5. Call back when a peak comes up often enough.\n */\nclass SonicServer {\n  constructor(params = {}) {\n    this.peakThreshold = params.peakThreshold || -65;\n    this.minRunLength = params.minRunLength || 2;\n    this.coder = params.coder || new SonicCoder(params);\n    // How long (in ms) to wait for the next character.\n    this.timeout = params.timeout || 300;\n    this.debug = !!params.debug;\n\n    this.peakHistory = new RingBuffer(16);\n    this.peakTimes = new RingBuffer(16);\n\n    this.callbacks = {};\n\n    this.buffer = '';\n    this.state = State.IDLE;\n    this.isRunning = false;\n    this.iteration = 0;\n  }\n  /**\n   * Start processing the audio stream.\n   */\n  start() {\n    // Start listening for microphone. Continue init in onStream.\n    const constraints = {\n      audio: { optional: [{ echoCancellation: false }] }\n    };\n    navigator.getMedia = (\n      navigator.getUserMedia ||\n      navigator.webkitGetUserMedia ||\n      navigator.mozGetUserMedia ||\n      navigator.msGetUserMedia\n    );\n\n    navigator.getMedia(\n      { audio: true },\n      this.onStream_.bind(this),\n      this.onStreamError_.bind(this)\n    );\n  }\n  /**\n   * Stop processing the audio stream.\n   */\n  stop() {\n    this.isRunning = false;\n    this.track.stop();\n  }\n  on(event, callback) {\n    if (event === 'message') {\n      this.callbacks.message = callback;\n    }\n    if (event === 'character') {\n      this.callbacks.character = callback;\n    }\n  }\n  setDebug(value) {\n    this.debug = value;\n\n    const canvas = document.querySelector('canvas');\n    if (canvas) {\n      // Remove it.\n      canvas.parentElement.removeChild(canvas);\n    }\n  }\n\n  fire_(callback, arg) {\n    if (typeof(callback) === 'function') {\n      callback(arg);\n    }\n  }\n\n  onStream_(stream) {\n    // Store MediaStreamTrack for stopping later. MediaStream.stop() is deprecated\n    // See https://developers.google.com/web/updates/2015/07/mediastream-deprecations?hl=en\n    this.track = stream.getTracks()[0];\n\n    // Setup audio graph.\n    const input = audioContext.createMediaStreamSource(stream);\n    const analyser = audioContext.createAnalyser();\n    input.connect(analyser);\n    // Create the frequency array.\n    this.freqs = new Float32Array(analyser.frequencyBinCount);\n    // Save the analyser for later.\n    this.analyser = analyser;\n    this.isRunning = true;\n    // Do an FFT and check for inaudible peaks.\n    this.raf_(this.loop.bind(this));\n  }\n\n  onStreamError_(e) {\n    console.error('Audio input error:', e);\n  }\n\n  /**\n   * Given an FFT frequency analysis, return the peak frequency in a frequency\n   * range.\n   */\n  getPeakFrequency() {\n    // Find where to start.\n    const start = this.freqToIndex(this.coder.freqMin);\n    // TODO: use first derivative to find the peaks, and then find the largest peak.\n    // Just do a max over the set.\n    let max = -Infinity;\n    let index = -1;\n    for (let i = start; i < this.freqs.length; i++) {\n      if (this.freqs[i] > max) {\n        max = this.freqs[i];\n        index = i;\n      }\n    }\n    // Only care about sufficiently tall peaks.\n    if (max > this.peakThreshold) {\n      return this.indexToFreq(index);\n    }\n    return null;\n  }\n\n  loop() {\n    this.analyser.getFloatFrequencyData(this.freqs);\n    // Sanity check the peaks every 5 seconds.\n    if ((this.iteration + 1) % (60 * 5) == 0) {\n      this.restartServerIfSanityCheckFails();\n    }\n    // Calculate peaks, and add them to history.\n    const freq = this.getPeakFrequency();\n    if (freq) {\n      const char = this.coder.freqToChar(freq);\n      // DEBUG ONLY: Output the transcribed char.\n      if (this.debug) {\n        console.log('Transcribed char: ' + char);\n      }\n      this.peakHistory.add(char);\n      this.peakTimes.add(new Date());\n    } else {\n      // If no character was detected, see if we've timed out.\n      const lastPeakTime = this.peakTimes.last();\n      if (lastPeakTime && new Date() - lastPeakTime > this.timeout) {\n        // Last detection was over 300ms ago.\n        this.state = State.IDLE;\n        if (this.debug) {\n          console.log('Token', this.buffer, 'timed out');\n        }\n        this.peakTimes.clear();\n      }\n    }\n    // Analyse the peak history.\n    this.analysePeaks();\n    // DEBUG ONLY: Draw the frequency response graph.\n    if (this.debug) {\n      this.debugDraw_();\n    }\n    if (this.isRunning) {\n      this.raf_(this.loop.bind(this));\n    }\n    this.iteration += 1;\n  }\n\n  indexToFreq(index) {\n    const nyquist = audioContext.sampleRate/2;\n    return nyquist/this.freqs.length * index;\n  }\n\n  freqToIndex(frequency) {\n    const nyquist = audioContext.sampleRate/2;\n    return Math.round(frequency/nyquist * this.freqs.length);\n  }\n\n  /**\n   * Analyses the peak history to find true peaks (repeated over several frames).\n   */\n  analysePeaks() {\n    // Look for runs of repeated characters.\n    const char = this.getLastRun();\n    if (!char) {\n      return;\n    }\n    if (this.state === State.IDLE) {\n      // If idle, look for start character to go into recv mode.\n      if (char === this.coder.startChar) {\n        this.buffer = '';\n        this.state = State.RECV;\n      }\n    } else if (this.state === State.RECV) {\n      // If receiving, look for character changes.\n      if (char !== this.lastChar &&\n          char !== this.coder.startChar && char !== this.coder.endChar) {\n        this.buffer += char;\n        this.lastChar = char;\n        this.fire_(this.callbacks.character, char);\n      }\n      // Also look for the end character to go into idle mode.\n      if (char === this.coder.endChar) {\n        this.state = State.IDLE;\n        this.fire_(this.callbacks.message, this.buffer);\n        this.buffer = '';\n      }\n    }\n  }\n\n  getLastRun() {\n    const lastChar = this.peakHistory.last();\n    let runLength = 0;\n    let i = this.peakHistory.length() - 2;\n    // Look at the peakHistory array for patterns like ajdlfhlkjxxxxxx$.\n    for (i; i >= 0; i--) {\n      const char = this.peakHistory.get(i);\n      if (char === lastChar) {\n        runLength += 1;\n      } else {\n        break;\n      }\n    }\n    if (runLength > this.minRunLength) {\n      // Remove it from the buffer.\n      this.peakHistory.remove(i + 1, runLength + 1);\n      return lastChar;\n    }\n    return null;\n  }\n\n  /**\n   * DEBUG ONLY.\n   */\n  debugDraw_() {\n    let canvas = document.querySelector('canvas');\n    if (!canvas) {\n      canvas = document.createElement('canvas');\n      document.body.appendChild(canvas);\n    }\n    canvas.width = document.body.offsetWidth;\n    canvas.height = 480;\n    const drawContext = canvas.getContext('2d');\n    // Plot the frequency data.\n    for (let i = 0; i < this.freqs.length; i++) {\n      const value = this.freqs[i];\n      // Transform this value (in db?) into something that can be plotted.\n      const height = value + 400;\n      const offset = canvas.height - height - 1;\n      const barWidth = canvas.width/this.freqs.length;\n      drawContext.fillStyle = 'black';\n      drawContext.fillRect(i * barWidth, offset, 1, 1);\n    }\n  }\n\n  /**\n   * A request animation frame shortcut. This one is intended to work even in\n   * background pages of an extension.\n   */\n  raf_(callback) {\n    const isCrx = !!(window.chrome && chrome.extension);\n    if (isCrx) {\n      setTimeout(callback, 1000/60);\n    } else {\n      requestAnimationFrame(callback);\n    }\n  }\n\n  restartServerIfSanityCheckFails() {\n    // Strange state 1: peaks gradually get quieter and quieter until they\n    // stabilize around -800.\n    if (this.freqs[0] < -300) {\n      console.error('freqs[0] < -300. Restarting.');\n      this.restart();\n      return;\n    }\n    // Strange state 2: all of the peaks are -100. Check just the first few.\n    let isValid = true;\n    for (let i = 0; i < 10; i++) {\n      if (this.freqs[i] === -100) {\n        isValid = false;\n      }\n    }\n    if (!isValid) {\n      console.error('freqs[0:10] == -100. Restarting.');\n      this.restart();\n    }\n  }\n\n  restart() {\n    //this.stop();\n    //this.start();\n    window.location.reload();\n  }\n}\n\nexport default SonicServer;\n\n\n\n// WEBPACK FOOTER //\n// ../lib/src/sonic-server.js","import SonicCoder from './sonic-coder.js';\nimport { audioContext, createGainNode } from './audiocontext';\n\n/**\n * Encodes text as audio streams.\n *\n * 1. Receives a string of text.\n * 2. Creates an oscillator.\n * 3. Converts characters into frequencies.\n * 4. Transmits frequencies, waiting in between appropriately.\n */\nclass SonicSocket {\n  constructor(params = {}) {\n    this.charDuration = params.charDuration || 0.2;\n    this.coder = params.coder || new SonicCoder(params);\n    this.rampDuration = params.rampDuration || 0.001;\n  }\n\n  send(input, opt_callback) {\n    // Surround the word with start and end characters.\n    input = this.coder.startChar + input + this.coder.endChar;\n    // Use WAAPI to schedule the frequencies.\n    for (let i = 0; i < input.length; i++) {\n      const char = input[i];\n      const freq = this.coder.charToFreq(char);\n      const time = audioContext.currentTime + this.charDuration * i;\n      this.scheduleToneAt(freq, time, this.charDuration);\n    }\n\n    // If specified, callback after roughly the amount of time it would have\n    // taken to transmit the token.\n    if (opt_callback) {\n      const totalTime = this.charDuration * input.length;\n      setTimeout(opt_callback, totalTime * 1000);\n    }\n  }\n\n  scheduleToneAt(freq, startTime, duration) {\n    // Gain => Merger\n    const gainNode = createGainNode(audioContext);\n    gainNode.gain.value = 0;\n\n    gainNode.gain.setValueAtTime(0, startTime);\n    gainNode.gain.linearRampToValueAtTime(1, startTime + this.rampDuration);\n    gainNode.gain.setValueAtTime(1, startTime + duration - this.rampDuration);\n    gainNode.gain.linearRampToValueAtTime(0, startTime + duration);\n\n    gainNode.connect(audioContext.destination);\n\n    const osc = audioContext.createOscillator();\n    osc.frequency.value = freq;\n    osc.connect(gainNode);\n\n    osc.start(startTime);\n  }\n}\n\nexport default SonicSocket;\n\n\n\n// WEBPACK FOOTER //\n// ../lib/src/sonic-socket.js","import { SonicSocket, SonicServer, SonicCoder } from '../../lib/src/index';\n\nconst EMOTICONS = ['happy', 'sad', 'heart', 'mad', 'star', 'oh'];\n// Calculate the alphabet based on the emoticons.\nconst ALPHABET = generateAlphabet(EMOTICONS);\nconst PLACEHOLDER = 'img/placeholder.gif';\n\nlet sonicSocket;\nlet sonicServer;\n\ncreateSonicNetwork();\n\nfunction createSonicNetwork(opt_coder) {\n  // Stop the sonic server if it is listening.\n  if (sonicServer) {\n    sonicServer.stop();\n  }\n  if (opt_coder) {\n    sonicServer = new SonicServer({coder: opt_coder});\n    sonicSocket = new SonicSocket({coder: opt_coder});\n  } else {\n    sonicServer = new SonicServer({alphabet: ALPHABET, debug: false});\n    sonicSocket = new SonicSocket({alphabet: ALPHABET});\n  }\n\n  sonicServer.start();\n  sonicServer.on('message', onIncomingEmoticon);\n}\n\n\n// Build the UI that lets you pick emoticons.\ncreateEmoticonList(EMOTICONS);\nif (isMobile()) {\n  document.querySelector('#mobile-warning').style.display = 'block';\n}\n\nconst isAudibleEl = document.querySelector('#is-audible');\nisAudibleEl.addEventListener('click', function(e) {\n  if (e.target.checked) {\n    const coder = new SonicCoder({\n      freqMin: 440,\n      freqMax: 1760\n    });\n    createSonicNetwork(coder);\n  } else {\n    createSonicNetwork();\n  }\n});\n\nconst isFullScreenEl = document.querySelector('#is-full-screen');\nisFullScreenEl.addEventListener('click', function(e) {\n  const selectEl = document.querySelector('#select-emoticon');\n  const recvEl = document.querySelector('#received-emoticon');\n  if (e.target.checked) {\n    selectEl.style.display = 'none';\n    recvEl.classList.add('big');\n  } else {\n    selectEl.style.display = 'block';\n    recvEl.classList.remove('big');\n  }\n});\n\nconst isVisualizer = document.querySelector('#is-visualizer');\nisVisualizer.addEventListener('click', function(e) {\n  sonicServer.setDebug(e.target.checked);\n});\n\nfunction generateAlphabet(list) {\n  let alphabet = '';\n  for (let i = 0; i < Math.min(list.length, 9); i++) {\n    alphabet += i.toString();\n  }\n  return alphabet;\n}\n\nfunction onPickEmoticon(e) {\n  const emoticonEl = e.target;\n  const name = emoticonEl.dataset.name;\n  // Highlight all emoticons except this one.\n  const emoticonEls = document.querySelectorAll('.emoticon');\n  for (let i = 0; i < emoticonEls.length; i++) {\n    const el = emoticonEls[i];\n    if (el === emoticonEl) {\n      el.classList.add('selected');\n    } else {\n      el.classList.remove('selected');\n    }\n  }\n\n  const index = EMOTICONS.indexOf(name);\n  sonicSocket.send(index.toString());\n}\n\nfunction createEmoticonList(list) {\n  const emoticonListEl = document.querySelector('#select-emoticon');\n  for (let i = 0; i < list.length; i++) {\n    const name = list[i];\n    // Create a button for each emoticon with the associated image.\n    const emoticonEl = document.createElement('img');\n    emoticonEl.classList.add('emoticon');\n    emoticonEl.src = getIcon(name);\n    emoticonEl.dataset.name = name;\n    emoticonEl.addEventListener('click', onPickEmoticon);\n\n    emoticonListEl.appendChild(emoticonEl);\n  }\n}\n\nfunction onIncomingEmoticon(message) {\n  console.log('message: ' + message);\n  const index = parseInt(message);\n  // Make the emoticon pop into view.\n  const emoticonEl = document.querySelector('#received-emoticon');\n  // Validate the message -- it has to be a single valid index.\n  const isValid = (!isNaN(index) && 0 <= index && index < EMOTICONS.length);\n  if (isValid) {\n    emoticonEl.src = getIcon(EMOTICONS[index]);\n    emoticonEl.classList.remove('placeholder');\n  } else {\n    emoticonEl.classList.add('placeholder');\n    emoticonEl.src = PLACEHOLDER;\n  }\n}\n\nfunction getIcon(name) {\n  return 'img/' + name + '.png';\n}\n\nfunction isMobile() {\n  let check = false;\n  (function(a){\n    if (/(android|bb\\d+|meego).+mobile|avantgo|bada\\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\\-(n|u)|c55\\/|capi|ccwa|cdm\\-|cell|chtm|cldc|cmd\\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\\-s|devi|dica|dmob|do(c|p)o|ds(12|\\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\\-|_)|g1 u|g560|gene|gf\\-5|g\\-mo|go(\\.w|od)|gr(ad|un)|haie|hcit|hd\\-(m|p|t)|hei\\-|hi(pt|ta)|hp( i|ip)|hs\\-c|ht(c(\\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\\-(20|go|ma)|i230|iac( |\\-|\\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\\/)|klon|kpt |kwc\\-|kyo(c|k)|le(no|xi)|lg( g|\\/(k|l|u)|50|54|\\-[a-w])|libw|lynx|m1\\-w|m3ga|m50\\/|ma(te|ui|xo)|mc(01|21|ca)|m\\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\\-2|po(ck|rt|se)|prox|psio|pt\\-g|qa\\-a|qc(07|12|21|32|60|\\-[2-7]|i\\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\\-|oo|p\\-)|sdk\\/|se(c(\\-|0|1)|47|mc|nd|ri)|sgh\\-|shar|sie(\\-|m)|sk\\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\\-|v\\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\\-|tdg\\-|tel(i|m)|tim\\-|t\\-mo|to(pl|sh)|ts(70|m\\-|m3|m5)|tx\\-9|up(\\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\\-|your|zeto|zte\\-/i.test(a.substr(0,4))) {\n      check = true\n    }\n  })(navigator.userAgent||navigator.vendor||window.opera);\n  return check;\n}\n\n\n\n// WEBPACK FOOTER //\n// ./emoticons/index.js"],"sourceRoot":""}